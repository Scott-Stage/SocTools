public List<AdGroup> GetAdUserGroups(string samAccountName)
{
    var groups = new System.Collections.Concurrent.ConcurrentBag<AdGroup>();

    using (DirectoryEntry entry = new DirectoryEntry("LDAP://DC=ftb,DC=ca,DC=gov"))
    using (DirectorySearcher searcher = new DirectorySearcher(entry))
    {
        // 1. Find the user again, but ONLY ask for 'memberOf'
        searcher.Filter = $"(sAMAccountName={samAccountName})";
        searcher.PropertiesToLoad.Add("memberOf");

        SearchResult result = searcher.FindOne();

        if (result == null || !result.Properties.Contains("memberOf"))
        {
            return new List<AdGroup>();
        }

        // 2. Get the collection of DNs
        var groupDns = result.Properties["memberOf"];

        // 3. Parallel Process: Speeds up looking up 50+ groups significantly
        System.Threading.Tasks.Parallel.ForEach(groupDns.Cast<string>(), groupDn =>
        {
            var groupDetail = GetGroupDetails(groupDn);
            if (groupDetail != null)
            {
                groups.Add(groupDetail);
            }
        });
    }

    return groups.ToList();
}





public async Task LoadUserProfile(string username)
{
    // 1. Fast Call: Get basic info immediately
    var userProfile = _adService.GetAdUserDetails(username);
    
    // Update UI (e.g. "Welcome, John Doe")
    StateHasChanged(); 

    // 2. Slow Call: Run this in background or show a "Loading Groups..." spinner
    // We wrap it in Task.Run because DirectoryServices is synchronous/blocking
    userProfile.Groups = await Task.Run(() => _adService.GetAdUserGroups(username));

    // Update UI again (e.g. Populate the Groups grid)
    StateHasChanged();
}