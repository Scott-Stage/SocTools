using System.Text;
using System.Text.Json;
using System.Net.Http;
using System.Threading.Tasks;

public async Task<List<TenableVulnerability>> GetVulnerabilities()
{
    // 1. Create the Request Object (using the Data Model)
    var analysisRequest = new TenableAnalysisRequest
    {
        Type = "vuln",
        Query = new TenableQuery
        {
            Tool = "listvuln",
            SourceType = "cumulative",
            StartOffset = 0,
            EndOffset = 1000,
            Filters = new List<TenableFilter>
            {
                new TenableFilter
                {
                    FilterName = "severity",
                    Operator = "=",
                    Value = "3,4" // High, Critical
                }
            }
        }
    };

    // 2. Serialize to JSON String
    string jsonPayload = JsonSerializer.Serialize(analysisRequest);

    // 3. Create Content (The Fix)
    // ❌ DO NOT USE: new FormUrlEncodedContent(...)
    // ✅ USE THIS:
    using var httpContent = new StringContent(jsonPayload, Encoding.UTF8, "application/json");

    // 4. Setup Client (Reuse your existing handler setup)
    var handler = new HttpClientHandler 
    { 
        UseCookies = false,
        ServerCertificateCustomValidationCallback = (m, c, ch, e) => true 
    };

    using var client = new HttpClient(handler);
    
    // Add Auth Headers (as discussed previously)
    string authHeader = $"accessKey={accessKey.Trim()}; secretKey={secretKey.Trim()}";
    client.DefaultRequestHeaders.TryAddWithoutValidation("X-ApiKey", authHeader);

    // 5. Send POST
    var response = await client.PostAsync($"{base_url}/analysis", httpContent);

    // 6. Handle Response
    string responseBody = await response.Content.ReadAsStringAsync();
    
    if (!response.IsSuccessStatusCode)
    {
        Console.WriteLine($"Error {response.StatusCode}: {responseBody}");
        return new List<TenableVulnerability>();
    }

    // 7. Deserialize Result
    var result = JsonSerializer.Deserialize<TenableScResponse<TenableAnalysisResult>>(responseBody);

    return result?.Response?.MatchingData ?? new List<TenableVulnerability>();
}