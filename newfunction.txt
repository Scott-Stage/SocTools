using System;
using System.Collections.Generic;
using System.DirectoryServices;
using System.Linq;
using System.Reflection;

public static class DirectoryServicesExtensions
{
    public static T ToObject<T>(this SearchResult result) where T : new()
    {
        var instance = new T();
        var type = typeof(T);
        var properties = type.GetProperties(BindingFlags.Public | BindingFlags.Instance);

        foreach (var prop in properties)
        {
            // 1. Identify the AD attribute name
            // You can use a custom attribute or just default to the property name
            string attributeName = prop.Name; 
            
            // Check if the ResultCollection contains this property
            if (result.Properties.Contains(attributeName))
            {
                var valCollection = result.Properties[attributeName];

                if (valCollection != null && valCollection.Count > 0)
                {
                    // 2. Handle Lists/Arrays (Multi-valued attributes like 'memberOf')
                    if (prop.PropertyType != typeof(string) && typeof(System.Collections.IEnumerable).IsAssignableFrom(prop.PropertyType))
                    {
                        var listType = prop.PropertyType.GetGenericArguments()[0];
                        var genericListType = typeof(List<>).MakeGenericType(listType);
                        var listInstance = (System.Collections.IList)Activator.CreateInstance(genericListType);

                        foreach (var item in valCollection)
                        {
                            // Helper to change type safely
                            listInstance.Add(Convert.ChangeType(item, listType));
                        }
                        prop.SetValue(instance, listInstance);
                    }
                    // 3. Handle Single Values (Strings, Ints, etc.)
                    else
                    {
                        // Always grab the first index [0] for single value properties
                        var rawValue = valCollection[0];
                        
                        // Handle potential DBNull or other AD artifacts
                        if (rawValue != null)
                        {
                            // Convert to correct type (e.g. "123" string -> 123 int)
                            var convertedValue = Convert.ChangeType(rawValue, prop.PropertyType);
                            prop.SetValue(instance, convertedValue);
                        }
                    }
                }
            }
        }
        return instance;
    }
}