export function getRelativePaths(input) {
    if (!input || !input.files) {
        return [];
    }

    return Array.from(input.files).map(function (file) {
        return file.webkitRelativePath || file.name;
    });
}

function ensureSvgSize(container, svg) {
    var width = container.clientWidth;
    var height = container.scrollHeight;
    svg.setAttribute("width", width);
    svg.setAttribute("height", height);
    svg.setAttribute("viewBox", "0 0 " + width + " " + height);
    svg.style.width = width + "px";
    svg.style.height = height + "px";
}

function buildSplinePath(start, end) {
    var x1 = start.x;
    var y1 = start.y;
    var x2 = end.x;
    var y2 = end.y;
    var delta = Math.max(40, Math.abs(x2 - x1) * 0.35);
    var c1x = x1 + delta;
    var c2x = x2 - delta;
    return "M " + x1 + " " + y1 + " C " + c1x + " " + y1 + " " + c2x + " " + y2 + " " + x2 + " " + y2;
}

function drawCrossZoneSplines(container, svg) {
    if (!container || !svg) {
        return;
    }

    ensureSvgSize(container, svg);
    while (svg.firstChild) {
        svg.removeChild(svg.firstChild);
    }

    var defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
    var marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
    marker.setAttribute("id", "acl-cross-zone-arrow");
    marker.setAttribute("viewBox", "0 0 10 10");
    marker.setAttribute("refX", "10");
    marker.setAttribute("refY", "5");
    marker.setAttribute("markerWidth", "6");
    marker.setAttribute("markerHeight", "6");
    marker.setAttribute("orient", "auto");
    var arrow = document.createElementNS("http://www.w3.org/2000/svg", "path");
    arrow.setAttribute("d", "M 0 0 L 10 5 L 0 10 z");
    arrow.setAttribute("fill", "var(--mud-palette-warning)");
    defs.appendChild(marker);
    marker.appendChild(arrow);
    svg.appendChild(defs);

    var sources = Array.from(container.querySelectorAll(".acl-cross-zone-source-marker[data-cross-zone-pairs]"));
    var destinations = Array.from(container.querySelectorAll(".acl-cross-zone-dest-marker[data-cross-zone-pairs]"));
    if (sources.length === 0 || destinations.length === 0) {
        return;
    }

    var containerRect = container.getBoundingClientRect();
    var scrollTop = container.scrollTop;

    sources.forEach(function (source) {
        var sourcePairs = parsePairTokens(source.getAttribute("data-cross-zone-pairs"));
        if (sourcePairs.length === 0) {
            return;
        }

        var sourceRect = source.getBoundingClientRect();
        var start = {
            x: Math.max(0, sourceRect.left - containerRect.left + 2),
            y: sourceRect.top - containerRect.top + scrollTop + sourceRect.height / 2
        };

        destinations.forEach(function (dest) {
            var destPairs = parsePairTokens(dest.getAttribute("data-cross-zone-pairs"));
            if (destPairs.length === 0) {
                return;
            }

            var destRect = dest.getBoundingClientRect();
            var matchedPairs = [];
            sourcePairs.forEach(function (sourcePair) {
                destPairs.forEach(function (destPair) {
                    if (sourcePair.id === destPair.id && sourcePair.side !== destPair.side) {
                        matchedPairs.push(sourcePair.id);
                    }
                });
            });

            if (matchedPairs.length === 0) {
                return;
            }

            var end = {
                x: Math.max(0, destRect.left - containerRect.left + destRect.width / 2),
                y: destRect.top - containerRect.top + scrollTop + destRect.height / 2
            };

            if (end.x <= start.x) {
                end.x = start.x + 20;
            }

            var uniquePairs = Array.from(new Set(matchedPairs));
            uniquePairs.forEach(function () {
                var path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", buildSplinePath(start, end));
                path.setAttribute("fill", "none");
                path.setAttribute("stroke", "var(--mud-palette-warning)");
                path.setAttribute("stroke-width", "1.4");
                path.setAttribute("stroke-linecap", "round");
                path.setAttribute("stroke-opacity", "0.85");
                path.setAttribute("marker-end", "url(#acl-cross-zone-arrow)");
                svg.appendChild(path);
            });
        });
    });
}

function parsePairTokens(value) {
    if (!value) {
        return [];
    }

    return value.split(",").map(function (token) {
        var trimmed = token.trim();
        if (!trimmed) {
            return null;
        }

        var side = trimmed.slice(-1);
        var id = parseInt(trimmed.slice(0, -1), 10);
        if (!Number.isFinite(id) || (side !== "A" && side !== "B")) {
            return null;
        }

        return { id: id, side: side };
    }).filter(function (entry) { return entry; });
}

export function renderCrossZoneSplines(container) {
    if (!container) {
        return;
    }

    var svg = container.querySelector(".acl-cross-zone-svg");
    if (!svg) {
        return;
    }

    if (!container.__crossZoneSplineHandler) {
        var handler = function () {
            if (container.__crossZoneSplineFrame) {
                cancelAnimationFrame(container.__crossZoneSplineFrame);
            }

            container.__crossZoneSplineFrame = requestAnimationFrame(function () {
                drawCrossZoneSplines(container, svg);
            });
        };

        container.__crossZoneSplineHandler = handler;
        container.addEventListener("scroll", handler);
        window.addEventListener("resize", handler);
    }

    drawCrossZoneSplines(container, svg);
}
